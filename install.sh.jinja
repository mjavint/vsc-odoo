#!/bin/bash
set -e
ODOO_SOURCE="OCA/OCB"
ODOO_VERSION="{{odoo_version}}"

echo "ðŸš€ Starting Odoo dependencies setup with uv..."

echo "ðŸ“¥ Downloading requirements.txt from $ODOO_SOURCE/$ODOO_VERSION..."
{%- if odoo_version < 17 %}
curl -o requirements.txt "https://raw.githubusercontent.com/$ODOO_SOURCE/$ODOO_VERSION/requirements.txt" \
    && sed -i -E "s/(gevent==)21\.8\.0( ; sys_platform != 'win32' and python_version > '3.9' and python_version <= '3.10')/\122.10.2\2/;s/(greenlet==)1.1.2( ; sys_platform != 'win32' and python_version  > '3.9' and python_version <= '3.10')/\12.0.2\2/" requirements.txt
{%- else %}
curl -o requirements.txt "https://raw.githubusercontent.com/$ODOO_SOURCE/$ODOO_VERSION/requirements.txt" \
    && sed -i -E "s/(gevent==)21\.8\.0( ; sys_platform != 'win32' and python_version == '3.10')/\122.10.2\2/;s/(greenlet==)1.1.2( ; sys_platform != 'win32' and python_version == '3.10')/\12.0.2\2/" requirements.txt
{%- endif %}

echo "ðŸ“¥ Creating virtual environment..."
uv sync

echo "ðŸ” Activating virtual environment and syncing dependencies..."
source .venv/bin/activate

echo "ðŸ“¥ Installing Python dependencies from requirements.txt..."
uv pip install --no-cache-dir -r requirements.txt

echo "ðŸ§¹ Cleaning up temporary requirements.txt file..."
rm requirements.txt 
echo "âœ… All dependencies installed successfully! Environment ready. ðŸŽ‰"
echo "ðŸ’¡ Activate your environment anytime with: source .venv/bin/activate"
